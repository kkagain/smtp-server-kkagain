# AI Agent Integration

This guide shows how to integrate the Universal SMTP MCP Server with various AI agents and applications.

## Model Context Protocol (MCP) Integration

The server natively supports the Model Context Protocol, making it easy to integrate with MCP-compatible AI agents.

### MCP Client Configuration

```json
{
  "mcpServers": {
    "smtp-server": {
      "command": "node",
      "args": ["path/to/smtp-mcp-server/build/index.js"],
      "env": {
        "PORT": "3008"
      }
    }
  }
}
```

### Available MCP Tools

The server exposes these tools through MCP:

- `send-email` - Send a single email
- `send-bulk-emails` - Send multiple emails with rate limiting  
- `get-smtp-configs` - Retrieve SMTP configurations
- `add-smtp-config` - Add new SMTP configuration
- `get-email-templates` - Retrieve email templates
- `add-email-template` - Create new email templates

## REST API Integration

For direct HTTP integration from any programming language:

### JavaScript/Node.js

```javascript
const axios = require('axios');

const smtpClient = axios.create({
  baseURL: 'http://localhost:3008/api',
  headers: {
    'Content-Type': 'application/json',
    // Optional: 'X-API-Key': 'your-api-key'
  }
});

// Send email
async function sendEmail(emailData) {
  try {
    const response = await smtpClient.post('/send-email', {
      to: [{ email: 'user@example.com', name: 'John Doe' }],
      subject: 'Hello from AI Agent',
      body: '<h1>Hello!</h1><p>This email was sent by an AI agent.</p>',
      from: { email: 'agent@yourcompany.com', name: 'AI Assistant' }
    });
    
    return response.data;
  } catch (error) {
    console.error('Email sending failed:', error.response.data);
    throw error;
  }
}

// Send email with template
async function sendTemplateEmail(templateId, recipientData) {
  const response = await smtpClient.post('/send-email', {
    to: [{ email: recipientData.email, name: recipientData.name }],
    templateId: templateId,
    templateData: {
      name: recipientData.name,
      company: 'Your Company',
      customMessage: 'Welcome to our AI-powered platform!'
    }
  });
  
  return response.data;
}
```

### Python

```python
import requests
import json

class SMTPClient:
    def __init__(self, base_url="http://localhost:3008/api", api_key=None):
        self.base_url = base_url
        self.headers = {"Content-Type": "application/json"}
        if api_key:
            self.headers["X-API-Key"] = api_key
    
    def send_email(self, to_email, subject, body, from_email=None):
        """Send a single email"""
        payload = {
            "to": [{"email": to_email}],
            "subject": subject,
            "body": body
        }
        
        if from_email:
            payload["from"] = {"email": from_email}
        
        response = requests.post(
            f"{self.base_url}/send-email",
            headers=self.headers,
            json=payload
        )
        response.raise_for_status()
        return response.json()
    
    def send_bulk_emails(self, email_list, rate_limit_delay=1000):
        """Send multiple emails with rate limiting"""
        payload = {
            "emails": email_list,
            "rateLimitDelay": rate_limit_delay
        }
        
        response = requests.post(
            f"{self.base_url}/send-bulk-emails",
            headers=self.headers,
            json=payload
        )
        response.raise_for_status()
        return response.json()

# Usage example
client = SMTPClient()

# Send simple email
result = client.send_email(
    to_email="user@example.com",
    subject="AI Generated Email",
    body="<h1>Hello!</h1><p>This was generated by an AI agent.</p>",
    from_email="ai@yourcompany.com"
)

print("Email sent:", result)
```

### cURL Examples

```bash
# Send simple email
curl -X POST http://localhost:3008/api/send-email \
  -H "Content-Type: application/json" \
  -d '{
    "to": [{"email": "user@example.com", "name": "John Doe"}],
    "subject": "Test from AI Agent",
    "body": "<h1>Hello!</h1><p>This is a test email from an AI agent.</p>"
  }'

# Send email with template
curl -X POST http://localhost:3008/api/send-email \
  -H "Content-Type: application/json" \
  -d '{
    "to": [{"email": "user@example.com", "name": "John Doe"}],
    "templateId": "welcome-template",
    "templateData": {
      "name": "John",
      "company": "Acme Corp"
    }
  }'

# Get server health
curl http://localhost:3008/api/health
```

## Common Integration Patterns

### 1. Notification System

```javascript
// AI agent sends notifications about completed tasks
async function notifyTaskCompletion(taskId, userEmail, taskDetails) {
  await sendEmail({
    to: [{ email: userEmail }],
    subject: `Task ${taskId} Completed`,
    body: `
      <h2>Task Completed Successfully</h2>
      <p><strong>Task ID:</strong> ${taskId}</p>
      <p><strong>Completed At:</strong> ${new Date().toISOString()}</p>
      <p><strong>Details:</strong> ${taskDetails}</p>
    `
  });
}
```

### 2. Report Generation

```python
def send_ai_generated_report(report_data, recipients):
    """Send AI-generated reports to multiple recipients"""
    
    # Generate HTML report
    html_content = generate_report_html(report_data)
    
    # Prepare emails for each recipient
    emails = []
    for recipient in recipients:
        emails.append({
            "to": [{"email": recipient["email"], "name": recipient["name"]}],
            "subject": f"AI Generated Report - {report_data['title']}",
            "body": html_content,
            "templateId": "report-template",
            "templateData": {
                "recipient_name": recipient["name"],
                "report_title": report_data["title"],
                "generated_at": datetime.now().isoformat()
            }
        })
    
    # Send bulk emails
    return client.send_bulk_emails(emails, rate_limit_delay=2000)
```

### 3. User Onboarding

```javascript
// AI agent handles new user onboarding emails
async function onboardNewUser(userData) {
  const welcomeSeries = [
    {
      delay: 0,
      templateId: "welcome-email",
      subject: "Welcome to Our Platform!"
    },
    {
      delay: 24 * 60 * 60 * 1000, // 24 hours
      templateId: "getting-started-guide", 
      subject: "Getting Started Guide"
    },
    {
      delay: 7 * 24 * 60 * 60 * 1000, // 7 days
      templateId: "feature-overview",
      subject: "Discover Our Features"
    }
  ];

  for (const email of welcomeSeries) {
    setTimeout(async () => {
      await sendTemplateEmail(email.templateId, userData);
    }, email.delay);
  }
}
```

## Authentication Integration

### Supabase Integration

When using multi-user mode with Supabase:

```javascript
const { createClient } = require('@supabase/supabase-js');

const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_ANON_KEY
);

// Authenticate with Supabase token
async function sendEmailWithAuth(userToken, emailData) {
  const { data: { user } } = await supabase.auth.getUser(userToken);
  
  if (!user) {
    throw new Error('Authentication required');
  }

  // Include user context in email
  const response = await smtpClient.post('/send-email', emailData, {
    headers: {
      'Authorization': `Bearer ${userToken}`
    }
  });
  
  return response.data;
}
```

### API Key Authentication

```bash
# Include API key in requests
curl -X POST http://localhost:3008/api/send-email \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-api-key-here" \
  -d '{"to": [{"email": "user@example.com"}], "subject": "Test", "body": "Hello!"}'
```

## Error Handling

### Robust Error Handling

```javascript
async function reliableSendEmail(emailData, maxRetries = 3) {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      const result = await sendEmail(emailData);
      console.log(`Email sent successfully on attempt ${attempt}`);
      return result;
    } catch (error) {
      console.error(`Attempt ${attempt} failed:`, error.message);
      
      if (attempt === maxRetries) {
        throw new Error(`Failed to send email after ${maxRetries} attempts: ${error.message}`);
      }
      
      // Exponential backoff
      const delay = Math.pow(2, attempt) * 1000;
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }
}
```

## Performance Optimization

### Bulk Email Processing

```python
def process_large_email_campaign(email_list, batch_size=100):
    """Process large email campaigns efficiently"""
    
    total_emails = len(email_list)
    sent_count = 0
    failed_count = 0
    
    # Process in batches
    for i in range(0, total_emails, batch_size):
        batch = email_list[i:i + batch_size]
        
        try:
            result = client.send_bulk_emails(batch, rate_limit_delay=500)
            sent_count += result.get('sent', 0)
            failed_count += result.get('failed', 0)
            
            print(f"Processed batch {i//batch_size + 1}: "
                  f"{sent_count} sent, {failed_count} failed")
            
        except Exception as e:
            print(f"Batch {i//batch_size + 1} failed: {e}")
            failed_count += len(batch)
    
    return {
        'total': total_emails,
        'sent': sent_count,
        'failed': failed_count
    }
```

## Integration Checklist

### Before Going Live

- [ ] **Test email delivery** with your SMTP provider
- [ ] **Configure rate limiting** appropriate for your provider
- [ ] **Set up monitoring** for email delivery status
- [ ] **Implement error handling** for failed deliveries
- [ ] **Test template rendering** with various data inputs
- [ ] **Verify authentication** (if using multi-user mode)
- [ ] **Configure logging** for audit trails
- [ ] **Set up backup SMTP** providers for redundancy

### Security Considerations

- [ ] **Use HTTPS** in production
- [ ] **Secure API keys** (environment variables, not hardcoded)
- [ ] **Implement rate limiting** to prevent abuse
- [ ] **Validate input data** to prevent injection attacks
- [ ] **Use authentication** for production deployments
- [ ] **Monitor for suspicious activity**

### Monitoring & Observability

```javascript
// Add comprehensive logging
const winston = require('winston');

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.json(),
  transports: [
    new winston.transports.File({ filename: 'email-activity.log' })
  ]
});

async function monitoredSendEmail(emailData) {
  const startTime = Date.now();
  
  try {
    logger.info('Email send started', {
      recipients: emailData.to.length,
      subject: emailData.subject,
      timestamp: new Date().toISOString()
    });
    
    const result = await sendEmail(emailData);
    
    logger.info('Email send completed', {
      duration: Date.now() - startTime,
      success: true,
      messageId: result.messageId
    });
    
    return result;
  } catch (error) {
    logger.error('Email send failed', {
      duration: Date.now() - startTime,
      error: error.message,
      recipients: emailData.to
    });
    throw error;
  }
}
```

## Support & Resources

- **Interactive API Docs**: http://localhost:3008/docs
- **GitHub Repository**: [Issues & Discussions](https://github.com/your-username/smtp-mcp-server)
- **Health Monitoring**: http://localhost:3008/api/health
- **OpenAPI Specification**: http://localhost:3008/api-docs.json
